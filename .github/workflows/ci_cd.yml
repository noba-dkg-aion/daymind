name: CI-CD

concurrency:
  group: main-ci
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  terraform_apply:
    runs-on: ubuntu-latest
    outputs:
      app_ip: ${{ steps.terraform.outputs.app_ip }}
    env:
      SHOULD_APPLY: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
      - name: Run pytest (API + infra)
        run: |
          pytest -q --ignore-glob='tests/test_mobile_*'
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Prepare SSH key
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p "${RUNNER_TEMP}"
          printf '%s\n' "$DEPLOY_SSH_KEY" > "${RUNNER_TEMP}/deploy_key"
          chmod 600 "${RUNNER_TEMP}/deploy_key"
      - name: Terraform Apply
        id: terraform
        env:
          DO_TOKEN: ${{ secrets.DO_TOKEN }}
          SSH_FINGERPRINT: ${{ secrets.SSH_FINGERPRINT }}
        run: |
          if [ "$SHOULD_APPLY" != "true" ]; then
            echo "Skipping Terraform apply for ref $GITHUB_REF"
            echo "app_ip=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          terraform -chdir=infra/terraform init
          terraform -chdir=infra/terraform validate
          terraform -chdir=infra/terraform apply -auto-approve \
            -var "do_token=$DO_TOKEN" \
            -var "ssh_fingerprint=$SSH_FINGERPRINT" \
            -var "ssh_private_key_path=${RUNNER_TEMP}/deploy_key"
          APP_IP=$(terraform -chdir=infra/terraform output -raw app_ip)
          echo "app_ip=$APP_IP"
          echo "app_ip=$APP_IP" >> "$GITHUB_OUTPUT"
      - name: Upload Terraform state
        if: ${{ env.SHOULD_APPLY == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: infra/terraform/terraform.tfstate

  deploy_app:
    needs: terraform_apply
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
    env:
      APP_IP: ${{ needs.terraform_apply.outputs.app_ip }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync
      - name: Prepare SSH key
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p "${RUNNER_TEMP}"
          printf '%s\n' "$DEPLOY_SSH_KEY" > "${RUNNER_TEMP}/deploy_key"
          chmod 600 "${RUNNER_TEMP}/deploy_key"
      - name: Trust droplet host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$APP_IP" >> ~/.ssh/known_hosts
      - name: Deploy application via helper script
        run: |
          KEY_PATH="${RUNNER_TEMP}/deploy_key"
          bash scripts/remote_deploy.sh \
            --host "$APP_IP" \
            --user "root" \
            --key "$KEY_PATH" | tee deploy.log
      - name: Upload deploy log
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log
          path: deploy.log

  verify_services:
    needs:
      - terraform_apply
      - deploy_app
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
    env:
      APP_IP: ${{ needs.terraform_apply.outputs.app_ip }}
    steps:
      - uses: actions/checkout@v4
      - name: Prepare SSH key
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p "${RUNNER_TEMP}"
          printf '%s\n' "$DEPLOY_SSH_KEY" > "${RUNNER_TEMP}/deploy_key"
          chmod 600 "${RUNNER_TEMP}/deploy_key"
      - name: Run remote healthcheck
        run: |
          ssh -i "${RUNNER_TEMP}/deploy_key" -o StrictHostKeyChecking=no "root@${APP_IP}" 'bash -s' < infra/systemd/checks/healthcheck.sh
      - name: Check /healthz endpoint
        run: curl -fsS "http://${APP_IP}/healthz"
      - name: Check /metrics endpoint
        run: curl -fsS "http://${APP_IP}/metrics"
